var $=Object.create;var m=Object.defineProperty;var z=Object.getOwnPropertyDescriptor;var J=Object.getOwnPropertyNames;var Z=Object.getPrototypeOf,tt=Object.prototype.hasOwnProperty;var O=i=>m(i,"__esModule",{value:!0});var et=(i,t)=>{for(var e in t)m(i,e,{get:t[e],enumerable:!0})},k=(i,t,e,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of J(t))!tt.call(i,r)&&(e||r!=="default")&&m(i,r,{get:()=>t[r],enumerable:!(a=z(t,r))||a.enumerable});return i},it=(i,t)=>k(O(m(i!=null?$(Z(i)):{},"default",!t&&i&&i.__esModule?{get:()=>i.default,enumerable:!0}:{value:i,enumerable:!0})),i),at=(i=>(t,e)=>i&&i.get(t)||(e=k(O({}),t,1),i&&i.set(t,e),e))(typeof WeakMap!="undefined"?new WeakMap:0);var pt={};et(pt,{default:()=>lt,delay:()=>L,getTestMediaEl:()=>v,hasPipSupport:()=>K,hasVolumeSupportAsync:()=>Y});var F=it(require("./media-container.js"),1),G=require("./utils/defineCustomElement.js"),o=require("./utils/server-safe-globals.js"),p=require("./utils/fullscreenApi.js"),U=require("./utils/stringUtils.js"),j=require("./utils/element-utils.js"),s=require("./constants.js"),E=require("./utils/captions.js");const{MEDIA_PLAY_REQUEST:_t,MEDIA_PAUSE_REQUEST:ht,MEDIA_MUTE_REQUEST:At,MEDIA_UNMUTE_REQUEST:It,MEDIA_VOLUME_REQUEST:mt,MEDIA_ENTER_FULLSCREEN_REQUEST:Tt,MEDIA_EXIT_FULLSCREEN_REQUEST:Mt,MEDIA_SEEK_REQUEST:ft,MEDIA_PREVIEW_REQUEST:Ut,MEDIA_ENTER_PIP_REQUEST:bt,MEDIA_EXIT_PIP_REQUEST:Dt,MEDIA_PLAYBACK_RATE_REQUEST:Rt}=s.MediaUIEvents;class C extends F.default{constructor(){super();dt||(this._airplayUnavailable=s.AvailabilityStates.UNSUPPORTED),ot||(this._pipUnavailable=s.AvailabilityStates.UNSUPPORTED),A!==void 0?A||(this._volumeUnavailable=s.AvailabilityStates.UNSUPPORTED):ct.then(()=>{A||(this._volumeUnavailable=s.AvailabilityStates.UNSUPPORTED,this.propagateMediaState(s.MediaUIAttributes.MEDIA_VOLUME_UNAVAILABLE,this._volumeUnavailable))}),this.mediaStateReceivers=[],this.associatedElementSubscriptions=new Map,this.associatedElements=[],this.associateElement(this);const t={MEDIA_PLAY_REQUEST:()=>this.media.play(),MEDIA_PAUSE_REQUEST:()=>this.media.pause(),MEDIA_MUTE_REQUEST:()=>this.media.muted=!0,MEDIA_UNMUTE_REQUEST:()=>{const e=this.media;e.muted=!1,e.volume===0&&(e.volume=.25)},MEDIA_VOLUME_REQUEST:e=>{const a=this.media,r=e.detail;a.volume=r,r>0&&a.muted&&(a.muted=!1);try{o.Window.localStorage.setItem("media-chrome-pref-volume",r.toString())}catch{}},MEDIA_ENTER_FULLSCREEN_REQUEST:()=>{const e=this.media;o.Document.pictureInPictureElement&&o.Document.exitPictureInPicture(),super[p.fullscreenApi.enter]?super[p.fullscreenApi.enter]():e.webkitEnterFullscreen?e.webkitEnterFullscreen():e.requestFullscreen?e.requestFullscreen():console.warn("MediaChrome: Fullscreen not supported")},MEDIA_EXIT_FULLSCREEN_REQUEST:()=>{o.Document[p.fullscreenApi.exit]()},MEDIA_ENTER_PIP_REQUEST:()=>{const e=this.media;!o.Document.pictureInPictureEnabled||(o.Document[p.fullscreenApi.element]&&o.Document[p.fullscreenApi.exit](),e.requestPictureInPicture())},MEDIA_EXIT_PIP_REQUEST:()=>{o.Document.pictureInPictureElement&&o.Document.exitPictureInPicture()},MEDIA_SEEK_REQUEST:e=>{const a=this.media,r=e.detail;(a.readyState>0||a.readyState===void 0)&&(a.currentTime=r)},MEDIA_PLAYBACK_RATE_REQUEST:e=>{this.media.playbackRate=e.detail},MEDIA_PREVIEW_REQUEST:e=>{var l;const a=this.media;if(!a)return;const[r]=(0,E.getTextTracksList)(a,{kind:s.TextTrackKinds.METADATA,label:"thumbnails"});if(!(r&&r.cues))return;const n=e.detail,c=Array.prototype.find.call(r.cues,_=>_.startTime>=n);if(!c)return;const I=/'^(?:[a-z]+:)?\/\//i.test(c.text)||(l=a.querySelector('track[label="thumbnails"]'))==null?void 0:l.src,d=new URL(c.text,I),S=new URLSearchParams(d.hash).get("#xywh");this.propagateMediaState(s.MediaUIAttributes.MEDIA_PREVIEW_IMAGE,d.href),this.propagateMediaState(s.MediaUIAttributes.MEDIA_PREVIEW_COORDS,S.split(",").join(" "))},MEDIA_SHOW_CAPTIONS_REQUEST:e=>{const a=M(this),{detail:r=[]}=e;(0,E.updateTracksModeTo)(s.TextTrackModes.SHOWING,a,r)},MEDIA_DISABLE_CAPTIONS_REQUEST:e=>{const a=M(this),{detail:r=[]}=e;(0,E.updateTracksModeTo)(s.TextTrackModes.DISABLED,a,r)},MEDIA_SHOW_SUBTITLES_REQUEST:e=>{const a=T(this),{detail:r=[]}=e;(0,E.updateTracksModeTo)(s.TextTrackModes.SHOWING,a,r)},MEDIA_DISABLE_SUBTITLES_REQUEST:e=>{const a=T(this),{detail:r=[]}=e;(0,E.updateTracksModeTo)(s.TextTrackModes.DISABLED,a,r)},MEDIA_AIRPLAY_REQUEST:e=>{const{media:a}=this;if(!!a){if(!(a.webkitShowPlaybackTargetPicker&&o.Window.WebKitPlaybackTargetAvailabilityEvent)){console.warn("received a request to select AirPlay but AirPlay is not supported in this environment");return}a.webkitShowPlaybackTargetPicker()}}};if(Object.keys(t).forEach(e=>{const a=`_handle${(0,U.constToCamel)(e,!0)}`;this[a]=r=>{if(r.stopPropagation(),!this.media){console.warn("MediaController: No media available.");return}t[e](r,this.media)},this.addEventListener(s.MediaUIEvents[e],this[a])}),this._mediaStatePropagators={"play,pause,emptied":()=>{this.propagateMediaState(s.MediaUIAttributes.MEDIA_PAUSED,N(this))},"playing,emptied":()=>{var e;this.propagateMediaState(s.MediaUIAttributes.MEDIA_HAS_PLAYED,!((e=this.media)==null?void 0:e.paused))},volumechange:()=>{this.propagateMediaState(s.MediaUIAttributes.MEDIA_MUTED,w(this)),this.propagateMediaState(s.MediaUIAttributes.MEDIA_VOLUME,x(this)),this.propagateMediaState(s.MediaUIAttributes.MEDIA_VOLUME_LEVEL,Q(this))},[p.fullscreenApi.event]:()=>{var a;let e=o.Document[p.fullscreenApi.element];this.propagateMediaState(s.MediaUIAttributes.MEDIA_IS_FULLSCREEN,e===((a=this.getRootNode().host)!=null?a:this))},"enterpictureinpicture,leavepictureinpicture":e=>{var r;let a;if(e)a=e.type=="enterpictureinpicture";else{const n=(r=this.getRootNode().pictureInPictureElement)!=null?r:o.Document.pictureInPictureElement;a=this.media&&(0,j.containsWithShadow)(this.media,n)}this.propagateMediaState(s.MediaUIAttributes.MEDIA_IS_PIP,a)},"timeupdate,loadedmetadata":()=>{this.propagateMediaState(s.MediaUIAttributes.MEDIA_CURRENT_TIME,B(this))},"durationchange,loadedmetadata,emptied":()=>{this.propagateMediaState(s.MediaUIAttributes.MEDIA_DURATION,V(this))},"progress,emptied":()=>{var e;this.propagateMediaState(s.MediaUIAttributes.MEDIA_BUFFERED,ut((e=this.media)==null?void 0:e.buffered))},ratechange:()=>{this.propagateMediaState(s.MediaUIAttributes.MEDIA_PLAYBACK_RATE,W(this))},"waiting,playing,emptied":()=>{var a;const e=((a=this.media)==null?void 0:a.readyState)<3;this.propagateMediaState(s.MediaUIAttributes.MEDIA_LOADING,e)}},this._airplayUnavailable!==s.AvailabilityStates.UNSUPPORTED){const e=a=>{(a==null?void 0:a.availability)==="available"?this._airplayUnavailable=void 0:(a==null?void 0:a.availability)==="not-available"&&(this._airplayUnavailable=s.AvailabilityStates.UNAVAILABLE),this.propagateMediaState(s.MediaUIAttributes.MEDIA_AIRPLAY_UNAVAILABLE,this._airplayUnavailable)};this._mediaStatePropagators.webkitplaybacktargetavailabilitychanged=e}this._textTrackMediaStatePropagators={"addtrack,removetrack,loadstart":()=>{this.propagateMediaState(s.MediaUIAttributes.MEDIA_CAPTIONS_LIST,(0,E.stringifyTextTrackList)(M(this))||void 0),this.propagateMediaState(s.MediaUIAttributes.MEDIA_SUBTITLES_LIST,(0,E.stringifyTextTrackList)(T(this))||void 0),this.propagateMediaState(s.MediaUIAttributes.MEDIA_CAPTIONS_SHOWING,(0,E.stringifyTextTrackList)(g(this))||void 0),this.propagateMediaState(s.MediaUIAttributes.MEDIA_SUBTITLES_SHOWING,(0,E.stringifyTextTrackList)(R(this))||void 0)},change:()=>{this.propagateMediaState(s.MediaUIAttributes.MEDIA_CAPTIONS_SHOWING,(0,E.stringifyTextTrackList)(g(this))||void 0),this.propagateMediaState(s.MediaUIAttributes.MEDIA_SUBTITLES_SHOWING,(0,E.stringifyTextTrackList)(R(this))||void 0)}}}mediaSetCallback(t){super.mediaSetCallback(t),Object.keys(this._mediaStatePropagators).forEach(e=>{const a=e.split(","),r=this._mediaStatePropagators[e];a.forEach(n=>{(n==p.fullscreenApi.event?this.getRootNode():t).addEventListener(n,r)}),r()}),Object.entries(this._textTrackMediaStatePropagators).forEach(([e,a])=>{e.split(",").forEach(n=>{t.textTracks&&t.textTracks.addEventListener(n,a)}),a()});try{const e=o.Window.localStorage.getItem("media-chrome-pref-volume");e!==null&&(t.volume=e)}catch(e){console.debug("Error getting volume pref",e)}}mediaUnsetCallback(t){super.mediaUnsetCallback(t),Object.keys(this._mediaStatePropagators).forEach(e=>{const a=e.split(","),r=this._mediaStatePropagators[e];a.forEach(n=>{(n==p.fullscreenApi.event?this.getRootNode():t).removeEventListener(n,r)})}),Object.entries(this._textTrackMediaStatePropagators).forEach(([e,a])=>{e.split(",").forEach(n=>{t.textTracks&&t.textTracks.removeEventListener(n,a)}),a()}),this.propagateMediaState(s.MediaUIAttributes.MEDIA_PAUSED,!0)}propagateMediaState(t,e){u(this.mediaStateReceivers,t,e);const a=new o.Window.CustomEvent(s.AttributeToStateChangeEventMap[t],{composed:!0,bubbles:!0,detail:e});this.dispatchEvent(a)}associateElement(t){if(!t)return;const{associatedElementSubscriptions:e}=this;if(e.has(t))return;const a=this.registerMediaStateReceiver.bind(this),r=this.unregisterMediaStateReceiver.bind(this),n=Et(t,a,r);Object.keys(s.MediaUIEvents).forEach(c=>{t.addEventListener(s.MediaUIEvents[c],this[`_handle${(0,U.constToCamel)(c,!0)}`])}),e.set(t,n)}unassociateElement(t){if(!t)return;const{associatedElementSubscriptions:e}=this;if(!e.has(t))return;e.get(t)(),e.delete(t),Object.keys(s.MediaUIEvents).forEach(r=>{t.removeEventListener(s.MediaUIEvents[r],this[`_handle${(0,U.constToCamel)(r,!0)}`])})}registerMediaStateReceiver(t){if(!t)return;const e=this.mediaStateReceivers;e.indexOf(t)>-1||(e.push(t),u([t],s.MediaUIAttributes.MEDIA_VOLUME_UNAVAILABLE,this._volumeUnavailable),u([t],s.MediaUIAttributes.MEDIA_AIRPLAY_UNAVAILABLE,this._airplayUnavailable),u([t],s.MediaUIAttributes.MEDIA_PIP_UNAVAILABLE,this._pipUnavailable),this.media&&(u([t],s.MediaUIAttributes.MEDIA_CAPTIONS_LIST,(0,E.stringifyTextTrackList)(M(this))||void 0),u([t],s.MediaUIAttributes.MEDIA_SUBTITLES_LIST,(0,E.stringifyTextTrackList)(T(this))||void 0),u([t],s.MediaUIAttributes.MEDIA_CAPTIONS_SHOWING,(0,E.stringifyTextTrackList)(g(this))||void 0),u([t],s.MediaUIAttributes.MEDIA_SUBTITLES_SHOWING,(0,E.stringifyTextTrackList)(R(this))||void 0),u([t],s.MediaUIAttributes.MEDIA_PAUSED,N(this)),u([t],s.MediaUIAttributes.MEDIA_MUTED,w(this)),u([t],s.MediaUIAttributes.MEDIA_VOLUME,x(this)),u([t],s.MediaUIAttributes.MEDIA_VOLUME_LEVEL,Q(this)),u([t],s.MediaUIAttributes.MEDIA_CURRENT_TIME,B(this)),u([t],s.MediaUIAttributes.MEDIA_DURATION,V(this)),u([t],s.MediaUIAttributes.MEDIA_PLAYBACK_RATE,W(this))))}unregisterMediaStateReceiver(t){const e=this.mediaStateReceivers,a=e.indexOf(t);a<0||e.splice(a,1)}}const N=i=>i.media?i.media.paused:!0,w=i=>!!(i.media&&i.media.muted),x=i=>{const t=i.media;return t?t.volume:1},Q=i=>{let t="high";if(!i.media)return t;const{muted:e,volume:a}=i.media;return a===0||e?t="off":a<.5?t="low":a<.75&&(t="medium"),t},B=i=>{const t=i.media;return t?t.currentTime:0},V=i=>{const t=i.media;return t?t.duration:NaN},W=i=>{const t=i.media;return t?t.playbackRate:1},T=i=>(0,E.getTextTracksList)(i.media,{kind:s.TextTrackKinds.SUBTITLES}),M=i=>(0,E.getTextTracksList)(i.media,{kind:s.TextTrackKinds.CAPTIONS}),R=i=>(0,E.getTextTracksList)(i.media,{kind:s.TextTrackKinds.SUBTITLES,mode:s.TextTrackModes.SHOWING}),g=i=>(0,E.getTextTracksList)(i.media,{kind:s.TextTrackKinds.CAPTIONS,mode:s.TextTrackModes.SHOWING}),st=Object.values(s.MediaUIAttributes),H=i=>{var a,r,n;const{constructor:{observedAttributes:t}}=i,e=(n=(r=(a=i==null?void 0:i.getAttribute)==null?void 0:a.call(i,s.MediaUIAttributes.MEDIA_CHROME_ATTRIBUTES))==null?void 0:r.split)==null?void 0:n.call(r,/\s+/);return Array.isArray(t||e)?(t||e).filter(c=>st.includes(c)):[]},P=i=>!!H(i).length,rt=async(i,t,e)=>(i.isConnected||await L(0),e==null?i.removeAttribute(t):typeof e=="boolean"?e?i.setAttribute(t,""):i.removeAttribute(t):Number.isNaN(e)?i.removeAttribute(t):i.setAttribute(t,e)),nt=i=>{var t;return!!((t=i.closest)==null?void 0:t.call(i,'*[slot="media"]'))},h=(i,t)=>{if(nt(i))return;const e=(r,n)=>{var S,l;P(r)&&n(r);const{children:c=[]}=r!=null?r:{},I=(l=(S=r==null?void 0:r.shadowRoot)==null?void 0:S.children)!=null?l:[];[...c,...I].forEach(_=>h(_,n))},a=i==null?void 0:i.nodeName.toLowerCase();if(a.includes("-")&&!P(i)){o.Window.customElements.whenDefined(a).then(()=>{e(i,t)});return}e(i,t)},u=(i,t,e)=>{i.forEach(a=>{!H(a).includes(t)||rt(a,t,e)})},Et=(i,t,e)=>{h(i,t);const a=d=>{var l;const S=(l=d==null?void 0:d.composedPath()[0])!=null?l:d.target;t(S)},r=d=>{var l;const S=(l=d==null?void 0:d.composedPath()[0])!=null?l:d.target;e(S)};i.addEventListener(s.MediaUIEvents.REGISTER_MEDIA_STATE_RECEIVER,a),i.addEventListener(s.MediaUIEvents.UNREGISTER_MEDIA_STATE_RECEIVER,r);const n=(d,S)=>{d.forEach(l=>{const{addedNodes:_=[],removedNodes:q=[],type:y,target:b,attributeName:X}=l;y==="childList"?(Array.prototype.forEach.call(_,D=>h(D,t)),Array.prototype.forEach.call(q,D=>h(D,e))):y==="attributes"&&X===s.MediaUIAttributes.MEDIA_CHROME_ATTRIBUTES&&(P(b)?t(b):e(b))})},c=new MutationObserver(n);return c.observe(i,{childList:!0,attributes:!0,subtree:!0}),()=>{h(i,e),c.disconnect(),i.removeEventListener(s.MediaUIEvents.REGISTER_MEDIA_STATE_RECEIVER,a),i.removeEventListener(s.MediaUIEvents.UNREGISTER_MEDIA_STATE_RECEIVER,r)}};let f;const v=()=>{var i,t;return f||(f=(t=(i=o.Document)==null?void 0:i.createElement)==null?void 0:t.call(i,"video"),f)},Y=async(i=v())=>{if(!i)return!1;const t=i.volume;return i.volume=t/2+.1,await L(0),i.volume!==t},L=i=>new Promise((t,e)=>setTimeout(t,i)),K=(i=v())=>typeof(i==null?void 0:i.requestPictureInPicture)=="function",ot=K();let A;const ct=Y().then(i=>(A=i,A)),dt=!!o.Window.WebKitPlaybackTargetAvailabilityEvent;function ut(i=[]){return Array.from(i).map((t,e)=>[Number(i.start(e).toFixed(2)),Number(i.end(e).toFixed(2))].join(":")).join(" ")}(0,G.defineCustomElement)("media-controller",C);var lt=C;module.exports=at(pt);
//# sourceMappingURL=media-controller.js.map
