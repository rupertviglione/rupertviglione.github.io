import X from"./media-container.js";import{defineCustomElement as $}from"./utils/defineCustomElement.js";import{Window as h,Document as u}from"./utils/server-safe-globals.js";import{fullscreenApi as _}from"./utils/fullscreenApi.js";import{constToCamel as y}from"./utils/stringUtils.js";import{containsWithShadow as z}from"./utils/element-utils.js";import{MediaUIEvents as l,MediaUIAttributes as r,TextTrackKinds as T,TextTrackModes as A,AvailabilityStates as I,AttributeToStateChangeEventMap as J}from"./constants.js";import{stringifyTextTrackList as p,getTextTracksList as M,updateTracksModeTo as D}from"./utils/captions.js";const{MEDIA_PLAY_REQUEST:At,MEDIA_PAUSE_REQUEST:It,MEDIA_MUTE_REQUEST:mt,MEDIA_UNMUTE_REQUEST:Tt,MEDIA_VOLUME_REQUEST:Mt,MEDIA_ENTER_FULLSCREEN_REQUEST:ft,MEDIA_EXIT_FULLSCREEN_REQUEST:Ut,MEDIA_SEEK_REQUEST:bt,MEDIA_PREVIEW_REQUEST:Dt,MEDIA_ENTER_PIP_REQUEST:Rt,MEDIA_EXIT_PIP_REQUEST:gt,MEDIA_PLAYBACK_RATE_REQUEST:Pt}=l;class w extends X{constructor(){super();Et||(this._airplayUnavailable=I.UNSUPPORTED),rt||(this._pipUnavailable=I.UNSUPPORTED),U!==void 0?U||(this._volumeUnavailable=I.UNSUPPORTED):nt.then(()=>{U||(this._volumeUnavailable=I.UNSUPPORTED,this.propagateMediaState(r.MEDIA_VOLUME_UNAVAILABLE,this._volumeUnavailable))}),this.mediaStateReceivers=[],this.associatedElementSubscriptions=new Map,this.associatedElements=[],this.associateElement(this);const e={MEDIA_PLAY_REQUEST:()=>this.media.play(),MEDIA_PAUSE_REQUEST:()=>this.media.pause(),MEDIA_MUTE_REQUEST:()=>this.media.muted=!0,MEDIA_UNMUTE_REQUEST:()=>{const t=this.media;t.muted=!1,t.volume===0&&(t.volume=.25)},MEDIA_VOLUME_REQUEST:t=>{const a=this.media,s=t.detail;a.volume=s,s>0&&a.muted&&(a.muted=!1);try{h.localStorage.setItem("media-chrome-pref-volume",s.toString())}catch{}},MEDIA_ENTER_FULLSCREEN_REQUEST:()=>{const t=this.media;u.pictureInPictureElement&&u.exitPictureInPicture(),super[_.enter]?super[_.enter]():t.webkitEnterFullscreen?t.webkitEnterFullscreen():t.requestFullscreen?t.requestFullscreen():console.warn("MediaChrome: Fullscreen not supported")},MEDIA_EXIT_FULLSCREEN_REQUEST:()=>{u[_.exit]()},MEDIA_ENTER_PIP_REQUEST:()=>{const t=this.media;!u.pictureInPictureEnabled||(u[_.element]&&u[_.exit](),t.requestPictureInPicture())},MEDIA_EXIT_PIP_REQUEST:()=>{u.pictureInPictureElement&&u.exitPictureInPicture()},MEDIA_SEEK_REQUEST:t=>{const a=this.media,s=t.detail;(a.readyState>0||a.readyState===void 0)&&(a.currentTime=s)},MEDIA_PLAYBACK_RATE_REQUEST:t=>{this.media.playbackRate=t.detail},MEDIA_PREVIEW_REQUEST:t=>{var d;const a=this.media;if(!a)return;const[s]=M(a,{kind:T.METADATA,label:"thumbnails"});if(!(s&&s.cues))return;const n=t.detail,E=Array.prototype.find.call(s.cues,m=>m.startTime>=n);if(!E)return;const b=/'^(?:[a-z]+:)?\/\//i.test(E.text)||(d=a.querySelector('track[label="thumbnails"]'))==null?void 0:d.src,o=new URL(E.text,b),S=new URLSearchParams(o.hash).get("#xywh");this.propagateMediaState(r.MEDIA_PREVIEW_IMAGE,o.href),this.propagateMediaState(r.MEDIA_PREVIEW_COORDS,S.split(",").join(" "))},MEDIA_SHOW_CAPTIONS_REQUEST:t=>{const a=g(this),{detail:s=[]}=t;D(A.SHOWING,a,s)},MEDIA_DISABLE_CAPTIONS_REQUEST:t=>{const a=g(this),{detail:s=[]}=t;D(A.DISABLED,a,s)},MEDIA_SHOW_SUBTITLES_REQUEST:t=>{const a=R(this),{detail:s=[]}=t;D(A.SHOWING,a,s)},MEDIA_DISABLE_SUBTITLES_REQUEST:t=>{const a=R(this),{detail:s=[]}=t;D(A.DISABLED,a,s)},MEDIA_AIRPLAY_REQUEST:t=>{const{media:a}=this;if(!!a){if(!(a.webkitShowPlaybackTargetPicker&&h.WebKitPlaybackTargetAvailabilityEvent)){console.warn("received a request to select AirPlay but AirPlay is not supported in this environment");return}a.webkitShowPlaybackTargetPicker()}}};if(Object.keys(e).forEach(t=>{const a=`_handle${y(t,!0)}`;this[a]=s=>{if(s.stopPropagation(),!this.media){console.warn("MediaController: No media available.");return}e[t](s,this.media)},this.addEventListener(l[t],this[a])}),this._mediaStatePropagators={"play,pause,emptied":()=>{this.propagateMediaState(r.MEDIA_PAUSED,x(this))},"playing,emptied":()=>{var t;this.propagateMediaState(r.MEDIA_HAS_PLAYED,!((t=this.media)==null?void 0:t.paused))},volumechange:()=>{this.propagateMediaState(r.MEDIA_MUTED,Q(this)),this.propagateMediaState(r.MEDIA_VOLUME,B(this)),this.propagateMediaState(r.MEDIA_VOLUME_LEVEL,V(this))},[_.event]:()=>{var a;let t=u[_.element];this.propagateMediaState(r.MEDIA_IS_FULLSCREEN,t===((a=this.getRootNode().host)!=null?a:this))},"enterpictureinpicture,leavepictureinpicture":t=>{var s;let a;if(t)a=t.type=="enterpictureinpicture";else{const n=(s=this.getRootNode().pictureInPictureElement)!=null?s:u.pictureInPictureElement;a=this.media&&z(this.media,n)}this.propagateMediaState(r.MEDIA_IS_PIP,a)},"timeupdate,loadedmetadata":()=>{this.propagateMediaState(r.MEDIA_CURRENT_TIME,W(this))},"durationchange,loadedmetadata,emptied":()=>{this.propagateMediaState(r.MEDIA_DURATION,H(this))},"progress,emptied":()=>{var t;this.propagateMediaState(r.MEDIA_BUFFERED,ot((t=this.media)==null?void 0:t.buffered))},ratechange:()=>{this.propagateMediaState(r.MEDIA_PLAYBACK_RATE,F(this))},"waiting,playing,emptied":()=>{var a;const t=((a=this.media)==null?void 0:a.readyState)<3;this.propagateMediaState(r.MEDIA_LOADING,t)}},this._airplayUnavailable!==I.UNSUPPORTED){const t=a=>{(a==null?void 0:a.availability)==="available"?this._airplayUnavailable=void 0:(a==null?void 0:a.availability)==="not-available"&&(this._airplayUnavailable=I.UNAVAILABLE),this.propagateMediaState(r.MEDIA_AIRPLAY_UNAVAILABLE,this._airplayUnavailable)};this._mediaStatePropagators.webkitplaybacktargetavailabilitychanged=t}this._textTrackMediaStatePropagators={"addtrack,removetrack,loadstart":()=>{this.propagateMediaState(r.MEDIA_CAPTIONS_LIST,p(g(this))||void 0),this.propagateMediaState(r.MEDIA_SUBTITLES_LIST,p(R(this))||void 0),this.propagateMediaState(r.MEDIA_CAPTIONS_SHOWING,p(k(this))||void 0),this.propagateMediaState(r.MEDIA_SUBTITLES_SHOWING,p(O(this))||void 0)},change:()=>{this.propagateMediaState(r.MEDIA_CAPTIONS_SHOWING,p(k(this))||void 0),this.propagateMediaState(r.MEDIA_SUBTITLES_SHOWING,p(O(this))||void 0)}}}mediaSetCallback(e){super.mediaSetCallback(e),Object.keys(this._mediaStatePropagators).forEach(t=>{const a=t.split(","),s=this._mediaStatePropagators[t];a.forEach(n=>{(n==_.event?this.getRootNode():e).addEventListener(n,s)}),s()}),Object.entries(this._textTrackMediaStatePropagators).forEach(([t,a])=>{t.split(",").forEach(n=>{e.textTracks&&e.textTracks.addEventListener(n,a)}),a()});try{const t=h.localStorage.getItem("media-chrome-pref-volume");t!==null&&(e.volume=t)}catch(t){console.debug("Error getting volume pref",t)}}mediaUnsetCallback(e){super.mediaUnsetCallback(e),Object.keys(this._mediaStatePropagators).forEach(t=>{const a=t.split(","),s=this._mediaStatePropagators[t];a.forEach(n=>{(n==_.event?this.getRootNode():e).removeEventListener(n,s)})}),Object.entries(this._textTrackMediaStatePropagators).forEach(([t,a])=>{t.split(",").forEach(n=>{e.textTracks&&e.textTracks.removeEventListener(n,a)}),a()}),this.propagateMediaState(r.MEDIA_PAUSED,!0)}propagateMediaState(e,t){c(this.mediaStateReceivers,e,t);const a=new h.CustomEvent(J[e],{composed:!0,bubbles:!0,detail:t});this.dispatchEvent(a)}associateElement(e){if(!e)return;const{associatedElementSubscriptions:t}=this;if(t.has(e))return;const a=this.registerMediaStateReceiver.bind(this),s=this.unregisterMediaStateReceiver.bind(this),n=it(e,a,s);Object.keys(l).forEach(E=>{e.addEventListener(l[E],this[`_handle${y(E,!0)}`])}),t.set(e,n)}unassociateElement(e){if(!e)return;const{associatedElementSubscriptions:t}=this;if(!t.has(e))return;t.get(e)(),t.delete(e),Object.keys(l).forEach(s=>{e.removeEventListener(l[s],this[`_handle${y(s,!0)}`])})}registerMediaStateReceiver(e){if(!e)return;const t=this.mediaStateReceivers;t.indexOf(e)>-1||(t.push(e),c([e],r.MEDIA_VOLUME_UNAVAILABLE,this._volumeUnavailable),c([e],r.MEDIA_AIRPLAY_UNAVAILABLE,this._airplayUnavailable),c([e],r.MEDIA_PIP_UNAVAILABLE,this._pipUnavailable),this.media&&(c([e],r.MEDIA_CAPTIONS_LIST,p(g(this))||void 0),c([e],r.MEDIA_SUBTITLES_LIST,p(R(this))||void 0),c([e],r.MEDIA_CAPTIONS_SHOWING,p(k(this))||void 0),c([e],r.MEDIA_SUBTITLES_SHOWING,p(O(this))||void 0),c([e],r.MEDIA_PAUSED,x(this)),c([e],r.MEDIA_MUTED,Q(this)),c([e],r.MEDIA_VOLUME,B(this)),c([e],r.MEDIA_VOLUME_LEVEL,V(this)),c([e],r.MEDIA_CURRENT_TIME,W(this)),c([e],r.MEDIA_DURATION,H(this)),c([e],r.MEDIA_PLAYBACK_RATE,F(this))))}unregisterMediaStateReceiver(e){const t=this.mediaStateReceivers,a=t.indexOf(e);a<0||t.splice(a,1)}}const x=i=>i.media?i.media.paused:!0,Q=i=>!!(i.media&&i.media.muted),B=i=>{const e=i.media;return e?e.volume:1},V=i=>{let e="high";if(!i.media)return e;const{muted:t,volume:a}=i.media;return a===0||t?e="off":a<.5?e="low":a<.75&&(e="medium"),e},W=i=>{const e=i.media;return e?e.currentTime:0},H=i=>{const e=i.media;return e?e.duration:NaN},F=i=>{const e=i.media;return e?e.playbackRate:1},R=i=>M(i.media,{kind:T.SUBTITLES}),g=i=>M(i.media,{kind:T.CAPTIONS}),O=i=>M(i.media,{kind:T.SUBTITLES,mode:A.SHOWING}),k=i=>M(i.media,{kind:T.CAPTIONS,mode:A.SHOWING}),Z=Object.values(r),G=i=>{var a,s,n;const{constructor:{observedAttributes:e}}=i,t=(n=(s=(a=i==null?void 0:i.getAttribute)==null?void 0:a.call(i,r.MEDIA_CHROME_ATTRIBUTES))==null?void 0:s.split)==null?void 0:n.call(s,/\s+/);return Array.isArray(e||t)?(e||t).filter(E=>Z.includes(E)):[]},C=i=>!!G(i).length,tt=async(i,e,t)=>(i.isConnected||await Y(0),t==null?i.removeAttribute(e):typeof t=="boolean"?t?i.setAttribute(e,""):i.removeAttribute(e):Number.isNaN(t)?i.removeAttribute(e):i.setAttribute(e,t)),et=i=>{var e;return!!((e=i.closest)==null?void 0:e.call(i,'*[slot="media"]'))},f=(i,e)=>{if(et(i))return;const t=(s,n)=>{var S,d;C(s)&&n(s);const{children:E=[]}=s!=null?s:{},b=(d=(S=s==null?void 0:s.shadowRoot)==null?void 0:S.children)!=null?d:[];[...E,...b].forEach(m=>f(m,n))},a=i==null?void 0:i.nodeName.toLowerCase();if(a.includes("-")&&!C(i)){h.customElements.whenDefined(a).then(()=>{t(i,e)});return}t(i,e)},c=(i,e,t)=>{i.forEach(a=>{!G(a).includes(e)||tt(a,e,t)})},it=(i,e,t)=>{f(i,e);const a=o=>{var d;const S=(d=o==null?void 0:o.composedPath()[0])!=null?d:o.target;e(S)},s=o=>{var d;const S=(d=o==null?void 0:o.composedPath()[0])!=null?d:o.target;t(S)};i.addEventListener(l.REGISTER_MEDIA_STATE_RECEIVER,a),i.addEventListener(l.UNREGISTER_MEDIA_STATE_RECEIVER,s);const n=(o,S)=>{o.forEach(d=>{const{addedNodes:m=[],removedNodes:K=[],type:N,target:v,attributeName:q}=d;N==="childList"?(Array.prototype.forEach.call(m,L=>f(L,e)),Array.prototype.forEach.call(K,L=>f(L,t))):N==="attributes"&&q===r.MEDIA_CHROME_ATTRIBUTES&&(C(v)?e(v):t(v))})},E=new MutationObserver(n);return E.observe(i,{childList:!0,attributes:!0,subtree:!0}),()=>{f(i,t),E.disconnect(),i.removeEventListener(l.REGISTER_MEDIA_STATE_RECEIVER,a),i.removeEventListener(l.UNREGISTER_MEDIA_STATE_RECEIVER,s)}};let P;const j=()=>{var i,e;return P||(P=(e=(i=u)==null?void 0:i.createElement)==null?void 0:e.call(i,"video"),P)},at=async(i=j())=>{if(!i)return!1;const e=i.volume;return i.volume=e/2+.1,await Y(0),i.volume!==e},Y=i=>new Promise((e,t)=>setTimeout(e,i)),st=(i=j())=>typeof(i==null?void 0:i.requestPictureInPicture)=="function",rt=st();let U;const nt=at().then(i=>(U=i,U)),Et=!!h.WebKitPlaybackTargetAvailabilityEvent;function ot(i=[]){return Array.from(i).map((e,t)=>[Number(i.start(t).toFixed(2)),Number(i.end(t).toFixed(2))].join(":")).join(" ")}$("media-controller",w);var vt=w;export{vt as default,Y as delay,j as getTestMediaEl,st as hasPipSupport,at as hasVolumeSupportAsync};
//# sourceMappingURL=media-controller.js.map
